<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>挑戰賽排行榜與成績</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body {
  font-family: sans-serif;
  max-width: 900px;
  margin: 30px auto;
  text-align: center;
  padding: 0 10px;
}
#logo {
  width: 150px;
  max-width: 80%;
  display: block;
  margin: 10px auto;
}
input, button {
  padding: 10px;
  font-size: 16px;
  width: 80%;
  max-width: 400px;
  margin: 10px auto;
  display: block;
}
table {
  margin: 20px auto;
  border-collapse: collapse;
  width: 100%;
  max-width: 880px;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px 10px;
  text-align: center;
  vertical-align: middle;
}
th { background-color: #f2f2f2; }
.pass { color: green; font-weight: bold; }
.not-tested { color: gray; font-style: italic; }
.locked { color: gray; font-style: italic; pointer-events: none; cursor: default; }
.completed { color: blue; font-weight: bold; }
a { text-decoration: none; color: inherit; }
a:hover { text-decoration: underline; }
.self-row { background-color: #cce5ff; }
.gold { background-color: #fff7c2; }
.silver { background-color: #f0f0f0; }
.bronze { background-color: #ffe5b4; }
@media (max-width: 600px) {
  input, button { width: 95%; }
  table, th, td { font-size: 14px; }
  #logo { width: 120px; }
}
</style>
</head>
<body>
<img src="logo.png" alt="Logo" id="logo" />
<h1>歡迎參加挑戰賽</h1>
<input id="nicknameInput" type="text" placeholder="請輸入您的姓名" />
<button onclick="queryScores()">查詢成績</button>

<div id="leaderboard"></div>
<div id="result"></div>

<script>
// ================== 單元設定 ==================
const allUnitsGrouped = [];
for(let i=1;i<=15;i++){
  const numStr = i<10?'0'+i:i;
  const ssUnit = `11-${i}-1 句子跟讀挑戰`;
  const sfUnit = `11-${i}-1 句子填空挑戰`;
  const stUnit = `11-${i}-1 句子聽打挑戰`;
  const ssLink = `https://yoonakorean.github.io/11${numStr}01SS/`;
  const sfLink = `https://yoonakorean.github.io/11${numStr}01SF/`;
  const stLink = `https://yoonakorean.github.io/11${numStr}01ST/`;
  allUnitsGrouped.push({ ssUnit, sfUnit, stUnit, ssLink, sfLink, stLink });
}

// ================== 工具函數 ==================
function maskName(name){ if(!name) return ""; if(name.length<2) return name; return name[0]+"O"+name.slice(2);}
function formatTime(seconds){ const m=Math.floor(seconds/60); const s=seconds%60; return `${m}:${s.toString().padStart(2,'0')}`; }

// ================== 排行榜渲染 ==================
function renderLeaderboard(leaderboard, userData=null, userIndex=-1){
  let html=`<h2>排行榜前三名</h2><table><thead><tr><th>名次</th><th>姓名</th><th>通關數</th><th>總分</th><th>平均時間</th></tr></thead><tbody>`;
  const medals=["🥇","🥈","🥉"];
  const medalClasses=["gold","silver","bronze"];
  leaderboard.slice(0,3).forEach((u,i)=>{
    const displayName = userData && u.name===userData.name?u.name:maskName(u.name);
    html+=`<tr class="${medalClasses[i]}"><td>${medals[i]}</td><td>${displayName}</td><td>${u.passCount}</td><td>${u.totalScore}</td><td>${formatTime(Math.round(u.avgTime))}</td></tr>`;
  });
  if(userData){
    html+=`<tr class="self-row"><td>${userIndex+1}</td><td>${userData.name}</td><td>${userData.passCount}</td><td>${userData.totalScore}</td><td>${formatTime(Math.round(userData.avgTime))}</td></tr>`;
  }else{
    html+=`<tr class="self-row"><td colspan="5">（此處顯示查詢使用者成績）</td></tr>`;
  }
  html+=`</tbody></table>`;
  document.getElementById("leaderboard").innerHTML=html;
}

// ================== 單元表渲染 ==================
function renderUnitTable(userData=null){
  let html=`<h2>單元列表</h2><table><thead><tr><th>句子跟讀挑戰</th><th>句子填空挑戰</th><th>句子聽打挑戰</th></tr></thead><tbody>`;
  allUnitsGrouped.forEach(row=>{
    const ssScore = userData?.units[row.ssUnit]?.score || 0;
    const sfScore = userData?.units[row.sfUnit]?.score || 0;
    const stScore = userData?.units[row.stUnit]?.score || 0;
    html+="<tr>";
    // 跟讀
    html+=`<td><a href="${row.ssLink}" target="_blank">${row.ssUnit}</a><br>${ssScore===100?'<span class="completed">完成</span>':'<span class="not-tested">未完成</span>'}</td>`;
    // 填空
    if(sfScore>0){
      html+=`<td><a href="${row.sfLink}" target="_blank">${row.sfUnit}</a><br><span class="${sfScore>=80?'pass':''}">${sfScore} 分${sfScore>=80?' ✅合格':''}</span></td>`;
    }else{
      html+=`<td class="not-tested"><a href="${row.sfLink}" target="_blank">${row.sfUnit}</a><br>尚未挑戰</td>`;
    }
    // 聽打
    if(sfScore<=0){
      html+=`<td class="locked">${row.stUnit}<br>需先完成填空挑戰</td>`;
    }else{
      if(stScore>0){
        html+=`<td><a href="${row.stLink}" target="_blank">${row.stUnit}</a><br><span class="${stScore>=80?'pass':''}">${stScore} 分${stScore>=80?' ✅合格':''}</span></td>`;
      }else{
        html+=`<td class="not-tested"><a href="${row.stLink}" target="_blank">${row.stUnit}</a><br>尚未挑戰</td>`;
      }
    }
    html+="</tr>";
  });
  html+="</tbody></table>";
  document.getElementById("result").innerHTML=html;
}

// ================== API 讀取與排行榜 ==================
async function loadLeaderboard(nickname=""){
  const resultDiv=document.getElementById("result");
  try{
    // 跟讀表單
    const ssApi = "https://sheet.best/api/sheets/YOUR_SS_API"; // <- 替換成你的 API
    const ssRes = await fetch(ssApi);
    const ssData = await ssRes.json();

    // 填空/聽打表單
    const sfApi = "https://api.sheetbest.com/sheets/6609511a-f588-4e4f-bd2b-ed551cab8770";
    const sfRes = await fetch(sfApi);
    const sfData = await sfRes.json();

    const userBest={};

    // 處理跟讀
    ssData.forEach(r=>{
      if(!r.nickname) return;
      const unit = r.unit || "";
      const score = Number(r.score) || 0;
      const time = Number(r.time) || 0;
      if(!userBest[r.nickname]) userBest[r.nickname]={};
      if(!userBest[r.nickname][unit] || score>userBest[r.nickname][unit].score){
        userBest[r.nickname][unit]={score,time};
      }
    });

    // 處理填空/聽打
    sfData.forEach(r=>{
      if(!r.nickname) return;
      const unit = r.gametitle || "";
      const score = Number(r.score) || 0;
      const time = Number(r.time) || 0;
      if(!userBest[r.nickname]) userBest[r.nickname]={};
      if(!userBest[r.nickname][unit] || score>userBest[r.nickname][unit].score){
        userBest[r.nickname][unit]={score,time};
      }
    });

    // 生成排行榜
    const leaderboard = Object.entries(userBest).map(([name,units])=>{
      const passed = Object.values(units).filter(u=>u.score>=80);
      const passCount = passed.length;
      const totalScore = Object.values(units).reduce((a,b)=>a+b.score,0);
      const totalTime = Object.values(units).reduce((a,b)=>a+b.time,0);
      const avgTime = Object.keys(units).length?totalTime/Object.keys(units).length:0;
      return {name,passCount,totalScore,avgTime,units};
    });

    leaderboard.sort((a,b)=>{
      if(b.passCount!==a.passCount) return b.passCount-a.passCount;
      if(b.totalScore!==a.totalScore) return b.totalScore-a.totalScore;
      return a.avgTime-b.avgTime;
    });

    let userData=null, userIndex=-1;
    if(nickname){
      userIndex=leaderboard.findIndex(u=>u.name.toLowerCase()===nickname.toLowerCase());
      userData=userIndex>=0?leaderboard[userIndex]:null;
    }

    renderLeaderboard(leaderboard,userData,userIndex);
    renderUnitTable(userData);

  }catch(err){
    console.error(err);
    resultDiv.innerHTML=`<p style="color:red;">發生錯誤，請稍後再試。</p>`;
  }
}

// ================== 查詢使用者 ==================
function queryScores(){
  const nickname=document.getElementById("nicknameInput").value.trim();
  if(nickname) loadLeaderboard(nickname);
}

// ================== 自動載入排行榜 ==================
window.onload=()=>loadLeaderboard();
</script>
</body>
</html>
